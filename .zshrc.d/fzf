#!/hint/zsh

#
# Reminder to myself how this works.
#
# 1. Random commands -> fzf-tab
#    `$ random-command <Tab>` -> compsys + fzf-tab
#
# 2. Select commands -> fzf/completion.zsh (`**` is `$FZF_COMPLETION_TRIGGER`)
#    `$ vim **<Tab>` -> _fzf_compgen_path()
#    `$ cd **<Tab>` -> _fzf_compgen_dir()
#    ...
#
# 3. Special Vi mode key combinations -> fzf/key-bindings.zsh
#    `/` -> `fzf-history-widget` (`$FZF_CTRL_R_OPTS`)
#           NB: relevance sorting is still `^R` because it is hardcoded in the widget!
#    `C` -> `fzf-cd-widget` (`$FZF_ALT_C_COMMAND`, `$FZF_ALT_C_OPTS`)
#    `^T` -> `fzf-file-widget` (`$FZF_CTRL_T_COMMAND`, `$FZF_CTRL_T_OPTS`)
#
# 4. Command-line usage: see `$FZF_DEFAULT_COMMAND`
#
# 5. All of the above: see `$FZF_DEFAULT_OPTS`
#

if ! [[ -d /usr/share/fzf ]]; then
	return
fi

source /usr/share/fzf/completion.zsh
source /usr/share/fzf/key-bindings.zsh

#
# Set up custom keybindings for fzf widgets
#

# Use zsh Normal Mode + / (reverse-i-search, vi-history-search-backward) to use fzf instead
# (likewise for Normal Mode + ?)
bindkey -M vicmd '/' fzf-history-widget
bindkey -M vicmd '?' fzf-history-widget
# Do not interpret Insert Mode + ESC + [/,] as _history-complete-* as it conflicts with normal Vi mode usage
bindkey -M viins -r '^[/'
bindkey -M viins -r '^[,'
# FIXME: HOWEVER, using ESC to exit Insert Mode is slightly broken, so
#        re-bind Insert Mode + ESC + / to the same fzf widget as configured above
bindkey -M viins '^[/' fzf-history-widget

# Do not interpret ESC + c as fzf-cd-widget as it conflicts with normal Vi mode usage
bindkey -M vicmd -r '^[c'
bindkey -M viins -r '^[c'
# Instead, use zsh Normal Mode + C (capital)
bindkey -M vicmd 'C' fzf-cd-widget

#
# Clever hack: set up double <Tab> instead of $FZF_COMPLETION_TRIGGER for default fzf completion
#

fzf-completion-notrigger() {
	# disable trigger just this once
	local FZF_COMPLETION_TRIGGER=""
	# if fzf-completion can't come up with something, call fzf-tab-complete
	# instead of the default completion widget (expand-or-complete).
	#
	# FIXME: triggers an infinite recursion on an empty prompt
	# _zsh_autosuggest_highlight_reset:3: maximum nested function level reached; increase FUNCNEST?
	#
	#local fzf_default_completion='fzf-tab-complete'
	fzf-completion "$@"
}
zle -N fzf-completion-notrigger

# Set an aggressive $KEYTIMEOUT to make usage of single <Tab> less miserable
KEYTIMEOUT=20
# Bind double <Tab>
bindkey '\t\t' fzf-completion-notrigger
# Bind Ctrl-Space in case I am unable to use double <Tab> due to a combination
# of the aggressive $KEYTIMEOUT on a slow link.
bindkey '^ ' fzf-completion-notrigger
